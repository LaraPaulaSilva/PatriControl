<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PatriControl ‚Äì Editar Patrim√¥nio</title>
  <!-- Fonte Segoe UI -->
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <!-- CSS da Sidebar e desta p√°gina -->
  <link rel="stylesheet" href="/codigo/css/sidebar.css">
  <link rel="stylesheet" href="/codigo/css/editarpatrimonio.css">
</head>
<body>
  <div id="sidebar-container"></div>
  <div class="dashboard-container">
    <main class="main-content">

      <header class="content-header">
        <h1>Editar Patrim√¥nio</h1>
        <div class="user-welcome">
          <span>Bem-vindo, <strong id="userName"></strong></span>
        </div>
      </header>

      <div id="notification" class="notification hidden">
        <div class="notification-content success">
          <span class="notification-message"></span>
        </div>
      </div>

      <div class="form-container">
        <form id="patrimonioForm">
          <!-- Linha 1 -->
          <div class="form-row">
            <div class="form-group">
              <label for="patrimonioNum">N¬∫ Patrim√¥nio</label>
              <input type="text" id="patrimonioNum" readonly>
            </div>
            <div class="form-group">
              <label for="nomePatrimonio">Nome do Patrim√¥nio</label>
              <input type="text" id="nomePatrimonio" required>
            </div>
          </div>

          <!-- Linha 2 -->
          <div class="form-row">
            <div class="form-group select-add-wrapper">
              <label for="filial">Filial</label>
              <div class="select-add-group">
                <select id="filial" required></select>
                <button type="button" class="icon-btn" id="btn-filial">‚ò∞</button>
              </div>
            </div>
            <div class="form-group select-add-wrapper">
              <label for="tipo">Tipo de Patrim√¥nio</label>
              <div class="select-add-group">
                <select id="tipo" required></select>
                <button type="button" class="icon-btn" id="btn-tipo">‚ò∞</button>
              </div>
            </div>
            <div class="form-group select-add-wrapper">
              <label for="fornecedor">Fornecedor</label>
              <div class="select-add-group">
                <select id="fornecedor" required></select>
                <button type="button" class="icon-btn" id="btn-fornecedor">‚ò∞</button>
              </div>
            </div>
          </div>

          <!-- Linha 3 -->
          <div class="form-row">
            <div class="form-group">
              <label for="notaFiscal">Nota Fiscal</label>
              <input type="text" id="notaFiscal">
            </div>
            <div class="form-group">
              <label for="dataCompra">Data da Compra</label>
              <input type="date" id="dataCompra" required>
            </div>
            <div class="form-group">
              <label for="valorCompra">Valor</label>
              <input type="number" id="valorCompra" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" required>
                <option value="Ativo">Ativo</option>
                <option value="Em Manuten√ß√£o">Em Manuten√ß√£o</option>
                <option value="Baixado">Baixado</option>
              </select>
            </div>
          </div>

          <!-- Foto -->
          <div class="form-row photo-row">
            <div class="profile-photo">
              <div class="avatar-placeholder" id="avatar"></div>
              <button type="button" class="delete-photo-btn" id="btn-delete-photo">üóë</button>
              <button type="button" class="edit-photo-btn" id="btn-edit-photo">‚úé</button>
              <input type="file" id="inputFoto" accept="image/*" hidden>
            </div>
          </div>

          <!-- Hist√≥rico -->
          <div class="form-row history-row">
            <div class="section">
              <div class="section-header">
                <h3>Tr√¢mites</h3>
                <button type="button" class="add-btn" id="btn-add-tramite">+</button>
              </div>
              <ul id="histTramites" class="history-list"></ul>
            </div>
            <div class="section">
              <div class="section-header">
                <h3>Manuten√ß√µes</h3>
                <button type="button" class="add-btn" id="btn-add-manut">+</button>
              </div>
              <ul id="histManutencao" class="history-list"></ul>
            </div>
          </div>

          <!-- A√ß√µes -->
          <div class="form-row actions">
            <a href="/docs/dashboard.html" class="btn cancel">Cancelar</a>
            <button type="submit" class="btn save">Salvar Altera√ß√µes</button>
          </div>
        </form>
      </div>

    </main>
  </div>

  <script src="/docs/utils.js"></script>
  <script src="/docs/sidebar.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const user = JSON.parse(localStorage.getItem("usuarioLogado") || "{}");
    if (!user.id) return window.location.href = "/docs/index.html";
    document.getElementById("userName").textContent = user.nome;

    const params = new URLSearchParams(location.search);
    const id     = params.get("id");
    const all    = JSON.parse(localStorage.getItem("patrimonios") || "[]");
    const patr   = all.find(p => p.numero === id);

    const notif   = document.getElementById("notification");
    const content = notif.querySelector(".notification-content");
    const msgEl   = notif.querySelector(".notification-message");
    function showNotification(msg, type = "success") {
      msgEl.textContent = msg;
      content.className = "notification-content " + (type === "error" ? "error" : "success");
      notif.classList.remove("hidden");
      setTimeout(() => notif.classList.add("hidden"), 3000);
    }

    // --- render espec√≠fico para TR√ÇMITES ---
    function renderTramites(patrimonioId) {
      const arr = JSON.parse(localStorage.getItem("tramites") || "[]")
        .filter(x => x.patrimonio === patrimonioId);
      const ul = document.getElementById("histTramites");
      ul.innerHTML = "";
      arr.forEach(item => {
        let detalhes = item.valorAntigo
          ? `| ${item.campo}: ${item.valorAntigo} | para | ${item.campo}: ${item.valorNovo}`
          : `| ${item.campo}: ${item.valorNovo}`;
        const li = document.createElement("li");
        li.textContent = `[${item.dataHora}] | ${item.idUsuario} | ${item.nomeUsuario} | ${item.acao} ${detalhes}`;
        ul.appendChild(li);
      });
    }

    // --- render espec√≠fico para MANUTEN√á√ïES ---
    function renderManutencoes(patrimonioId) {
      const arr = JSON.parse(localStorage.getItem("manutencoes") || "[]")
        .filter(x => x.patrimonio === patrimonioId);
      const ul = document.getElementById("histManutencao");
      ul.innerHTML = "";
      arr.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `[${item.dataHora}] | ${item.idUsuario} | ${item.nomeUsuario} | ${item.acao}`;
        ul.appendChild(li);
      });
    }

    // campos iniciais
    document.getElementById("patrimonioNum").value  = patr.numero;
    document.getElementById("nomePatrimonio").value = patr.nome;
    document.getElementById("notaFiscal").value     = patr.nf;
    document.getElementById("dataCompra").value     = patr.dataCompra;
    document.getElementById("valorCompra").value    = patr.valor;
    document.getElementById("status").value         = patr.status;

    // popula selects
    ["filial","tipo","fornecedor"].forEach(key => {
      const sel = document.getElementById(key);
      JSON.parse(localStorage.getItem(key) || "[]")
        .forEach(v => sel.add(new Option(v, v)));
      sel.value = patr[key];
      document.getElementById("btn-" + key).onclick = () => abrirCrud(key);
    });

    // imagem
    const avatar    = document.getElementById("avatar"),
          inputFoto = document.getElementById("inputFoto");
    if (patr.imagem) avatar.innerHTML = `<img src="${patr.imagem}">`;
    document.getElementById("btn-edit-photo").onclick = () => inputFoto.click();
    document.getElementById("btn-delete-photo").onclick = () => {
      const old = patr.imagem || "";
      patr.imagem = "";
      avatar.innerHTML = "";
      registrarMudanca("Imagem", old ? "alterada" : "removida", old, "");
      salvar(); showNotification("Imagem removida");
    };
    inputFoto.addEventListener("change", () => {
      const file = inputFoto.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const old = patr.imagem || "";
        patr.imagem = e.target.result;
        avatar.innerHTML = `<img src="${patr.imagem}">`;
        registrarMudanca("Imagem", old ? "alterada" : "inserida", old, e.target.result);
        salvar(); showNotification("Imagem atualizada");
      };
      reader.readAsDataURL(file);
    });

    // chama renders iniciais
    renderTramites(id);
    renderManutencoes(id);

    // CRUD filial/tipo/forn
    function abrirCrud(key) {
      const mc    = document.getElementById("modal-container"),
            lista = JSON.parse(localStorage.getItem(key) || "[]");
      mc.innerHTML = `
        <div class="modal-box">
          <h2>Gerenciar ${key[0].toUpperCase() + key.slice(1)}</h2>
          <div class="modal-form">
            <input id="novo-${key}" placeholder="Novo ${key}">
            <button id="confirmAdd" class="btn save">Adicionar</button>
          </div>
          <ul class="modal-lista">
            ${lista.map((v, i) => `
              <li>
                <input value="${v}" onchange="editar('${key}',${i},this.value)">
                <button onclick="excluir('${key}',${i})" class="btn cancel">‚úñ</button>
              </li>`).join("")}
          </ul>
          <button class="btn cancel" onclick="fecharModal()">Fechar</button>
        </div>`;
      mc.classList.remove("hidden");
      document.getElementById("confirmAdd").onclick = () => {
        const v = document.getElementById("novo-" + key).value.trim();
        if (!v) return;
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        arr.push(v);
        localStorage.setItem(key, JSON.stringify(arr));
        fecharModal(); abrirCrud(key);
      };
    }
    window.fecharModal = () => document.getElementById("modal-container").classList.add("hidden");
    window.editar      = (k, i, v) => {
      const a   = JSON.parse(localStorage.getItem(k) || "[]"),
            old = a[i];
      a[i] = v;
      localStorage.setItem(k, JSON.stringify(a));
      registrarMudanca(k[0].toUpperCase() + k.slice(1), "alterado", old, v);
    };
    window.excluir    = (k, i) => {
      const a   = JSON.parse(localStorage.getItem(k) || "[]"),
            old = a[i];
      a.splice(i, 1);
      localStorage.setItem(k, JSON.stringify(a));
      abrirCrud(k);
      registrarMudanca(k[0].toUpperCase() + k.slice(1), "removido", old, "");
    };

    // modal hist√≥ricos (tramites e manutencoes)
    function abrirHistorico(chave, titulo) {
      const mc    = document.getElementById("modal-container"),
            lista = JSON.parse(localStorage.getItem(chave) || "[]")
                      .filter(x => x.patrimonio === id);
      mc.innerHTML = `
        <div class="modal-box">
          <h2>${titulo}</h2>
          <div class="modal-form">
            <input id="novo-hist" placeholder="Nova ${titulo.toLowerCase()}">
            <button id="confirmHist" class="btn save">Adicionar</button>
          </div>
          <ul class="modal-lista">
            ${lista.map(item => `<li>${item.dataHora} ‚Äî ${item.nomeUsuario || item.usuario}: ${item.acao}</li>`).join("")}
          </ul>
          <button class="btn cancel" onclick="fecharModal()">Fechar</button>
        </div>`;
      mc.classList.remove("hidden");
      document.getElementById("confirmHist").onclick = () => {
        const v = document.getElementById("novo-hist").value.trim();
        if (!v) return;
        const arr = JSON.parse(localStorage.getItem(chave) || "[]");
        arr.push({
          patrimonio:  id,
          idUsuario:   user.id,
          nomeUsuario: user.nome,
          acao:        v,
          dataHora:    new Date().toLocaleString()
        });
        localStorage.setItem(chave, JSON.stringify(arr));
        fecharModal();
        if (chave === "tramites") renderTramites(id);
        else                renderManutencoes(id);
        abrirHistorico(chave, titulo);
      };
    }
    document.getElementById("btn-add-tramite").onclick = () => abrirHistorico("tramites", "Tr√¢mites");
    document.getElementById("btn-add-manut") .onclick = () => abrirHistorico("manutencoes", "Manuten√ß√µes");

    // registra mudan√ßa gen√©rica (sempre tramites)
    function registrarMudanca(campo, tipo, oldVal, newVal) {
      const tr  = JSON.parse(localStorage.getItem("tramites") || "[]");
      const now = new Date();
      const dt  = now.toLocaleDateString();
      const tm  = now.toLocaleTimeString();

      tr.push({
        patrimonio:   id,
        idUsuario:    user.id,
        nomeUsuario:  user.nome,
        acao:         "Alterou",
        campo:        campo.toUpperCase(),
        valorAntigo:  oldVal,
        valorNovo:    newVal,
        dataHora:     `${dt}, ${tm}`
      });
      localStorage.setItem("tramites", JSON.stringify(tr));
      renderTramites(id);
    }

    // submit salva e volta ao dashboard
    document.getElementById("patrimonioForm").addEventListener("submit", e => {
      e.preventDefault();
      const velho = {
        nome:      patr.nome,
        filial:    patr.filial,
        tipo:      patr.tipo,
        fornecedor:patr.fornecedor,
        nf:        patr.nf,
        dataCompra:patr.dataCompra,
        valor:     patr.valor,
        status:    patr.status
      };
      patr.nome       = document.getElementById("nomePatrimonio").value.trim();
      patr.filial     = document.getElementById("filial").value;
      patr.tipo       = document.getElementById("tipo").value;
      patr.fornecedor = document.getElementById("fornecedor").value;
      patr.nf         = document.getElementById("notaFiscal").value.trim();
      patr.dataCompra = document.getElementById("dataCompra").value;
      patr.valor      = parseFloat(document.getElementById("valorCompra").value) || 0;
      patr.status     = document.getElementById("status").value;

      if (velho.nome       !== patr.nome)       registrarMudanca("Nome",             "alterado", velho.nome,       patr.nome);
      if (velho.filial     !== patr.filial)     registrarMudanca("Filial",           "alterado", velho.filial,     patr.filial);
      if (velho.tipo       !== patr.tipo)       registrarMudanca("Tipo de Patrim√¥nio","alterado", velho.tipo,       patr.tipo);
      if (velho.fornecedor !== patr.fornecedor) registrarMudanca("Fornecedor",       "alterado", velho.fornecedor, patr.fornecedor);
      if (velho.nf         !== patr.nf)         registrarMudanca("Nota Fiscal",      "alterado", velho.nf,         patr.nf);
      if (velho.dataCompra !== patr.dataCompra) registrarMudanca("Data de Compra",   "alterado", velho.dataCompra, patr.dataCompra);
      if (velho.valor      !== patr.valor)      registrarMudanca("Valor",            "alterado", velho.valor,      patr.valor);
      if (velho.status     !== patr.status)     registrarMudanca("Status",           "alterado", velho.status,     patr.status);

      localStorage.setItem("patrimonios", JSON.stringify(all));
      showNotification("Altera√ß√µes salvas");
      setTimeout(() => window.location.href = "/docs/dashboard.html", 500);
    });
  });
  </script>

  <div id="modal-container" class="modal-container hidden"></div>
</body>
</html>
