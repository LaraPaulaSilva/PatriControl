<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PatriControl - Editar Usuário</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/docs/sidebar.css">
  <link rel="stylesheet" href="/docs/editarusuario.css">
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container"></div>

  <!-- Conteúdo Principal -->
  <div class="dashboard-container">
    <main class="main-content">

      <!-- Cabeçalho -->
      <header class="content-header">
        <h1>Editar Usuário</h1>
        <div class="user-welcome">
          <span>Bem-vindo, <strong id="userName">Usuário</strong></span>
        </div>
      </header>

      <!-- Notificação de sucesso -->
      <div id="notification" class="notification hidden">
        <div class="notification-content">
          <span class="notification-message">Usuário atualizado com sucesso!</span>
        </div>
      </div>

      <!-- Formulário de Edição -->
      <div class="form-container">
        <form id="editarUsuarioForm">

          <!-- Código somente leitura -->
          <div class="form-row">
            <div class="form-group">
              <label for="codigoUsuario">Código do Usuário</label>
              <input type="text" id="codigoUsuario" readonly class="readonly-input">
            </div>
          </div>

          <!-- Nome e email -->
          <div class="form-row">
            <div class="form-group">
              <label for="nome">Nome Completo</label>
              <input type="text" id="nome" required>
            </div>
            <div class="form-group">
              <label for="email">E-mail</label>
              <input type="email" id="email" required>
            </div>
          </div>

          <!-- Cargo e Filial com botão hambúrguer -->
          <div class="form-row aligned-row">
            <div class="form-group">
              <label for="cargo">Cargo</label>
              <div class="select-add-group">
                <select id="cargo" class="full-dropdown" required></select>
                <button type="button" id="btn-cargo" class="icon-btn">&#x2630;</button>
              </div>
            </div>
            <div class="form-group">
              <label for="filial">Filial</label>
              <div class="select-add-group">
                <select id="filial" class="full-dropdown" required></select>
                <button type="button" id="btn-filial" class="icon-btn">&#x2630;</button>
              </div>
            </div>
          </div>

          <!-- Status e Administrador -->
          <div class="form-row aligned-row">
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" class="full-dropdown" required>
                <option value="Ativo">Ativo</option>
                <option value="Inativo">Inativo</option>
              </select>
            </div>
            <div class="form-group">
              <label for="administrador">Administrador</label>
              <select id="administrador" class="full-dropdown" required>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>
          </div>

          <!-- Nova senha -->
          <div class="form-row">
            <div class="form-group">
              <label for="novaSenha">Nova Senha</label>
              <input type="password" id="novaSenha" placeholder="Deixe em branco para manter a senha atual">
            </div>
          </div>

          <!-- Botões -->
          <div class="form-row actions">
            <button type="button" class="btn cancel" onclick="window.location='/docs/gerenciamentodeusuario.html'">Cancelar</button>
            <button type="submit" class="btn save">Salvar Alterações</button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <!-- Modal Container -->
  <div id="modal-container"></div>

  <!-- Scripts -->
  <script src="/docs/utils.js"></script>
  <script src="/docs/sidebar.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // checa permissão
    const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado") || "{}");
    if (!usuarioLogado.administrador || usuarioLogado.administrador !== "Sim") {
      alert("Acesso restrito. Permissão de administrador necessária.");
      return window.location.href = "/docs/dashboard.html";
    }
    document.getElementById("userName").textContent = usuarioLogado.nome;

    // pega id da URL
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const usuario = usuarios.find(u => u.id === id);
    if (!usuario) {
      alert("Usuário inválido.");
      return window.location.href = "/docs/gerenciamentodeusuario.html";
    }

    // preenche campos fixos
    document.getElementById("codigoUsuario").value = usuario.id;
    document.getElementById("nome").value = usuario.nome;
    document.getElementById("email").value = usuario.email;
    document.getElementById("status").value = usuario.status;
    document.getElementById("administrador").value = usuario.administrador;

    // Função de recarregar um select
    function atualizarSelect(tipo) {
      const sel = document.getElementById(tipo);
      sel.innerHTML = "";
      JSON.parse(localStorage.getItem(tipo) || "[]")
        .forEach(item => {
          const opt = document.createElement("option");
          opt.value = item;
          opt.textContent = item;
          sel.appendChild(opt);
        });
    }

    // inicializa os selects
    atualizarSelect("cargo");
    atualizarSelect("filial");
    document.getElementById("cargo").value = usuario.cargo;
    document.getElementById("filial").value = usuario.filial;

    // funções de modal CRUD para cargo/filial
    function abrirModal(tipo) {
      const title = tipo.charAt(0).toUpperCase() + tipo.slice(1);
      const dados = JSON.parse(localStorage.getItem(tipo) || "[]");
      const mc = document.getElementById("modal-container");
      mc.innerHTML = `
        <div class="modal-overlay" onclick="fecharModal()"></div>
        <div class="modal">
          <h2>Gerenciar ${title}</h2>
          <div class="modal-form">
            <input type="text" id="novo-${tipo}" placeholder="Novo ${title}">
            <button id="btn-add-${tipo}" class="btn save">Adicionar</button>
          </div>
          <ul id="lista-${tipo}" class="modal-lista">
            ${dados.map((item, idx) => `
              <li>
                <input value="${item}" onchange="editarItem('${tipo}',${idx},this.value)">
                <button onclick="excluirItem('${tipo}',${idx})" class="btn cancel">X</button>
              </li>
            `).join("")}
          </ul>
          <button class="btn cancel" onclick="fecharModal()">Fechar</button>
        </div>`;
      mc.style.display = "block";

      // adicionar
      document.getElementById("btn-add-"+tipo).onclick = () => {
        const val = document.getElementById("novo-"+tipo).value.trim();
        if (!val) return;
        const arr = JSON.parse(localStorage.getItem(tipo) || "[]");
        if (!arr.includes(val)) {
          arr.push(val);
          localStorage.setItem(tipo, JSON.stringify(arr));
          atualizarSelect(tipo);      // <— recarrega o select imediatamente
        }
        abrirModal(tipo); // reabre para atualizar a lista interna
      };
    }

    function fecharModal() {
      const mc = document.getElementById("modal-container");
      mc.innerHTML = "";
      mc.style.display = "none";
    }

    window.abrirModal = abrirModal;
    window.fecharModal = fecharModal;

    window.editarItem = (tipo, idx, novoVal) => {
      const arr = JSON.parse(localStorage.getItem(tipo) || "[]");
      arr[idx] = novoVal;
      localStorage.setItem(tipo, JSON.stringify(arr));
      atualizarSelect(tipo);        // <— recarrega o select
    };

    window.excluirItem = (tipo, idx) => {
      const arr = JSON.parse(localStorage.getItem(tipo) || "[]");
      arr.splice(idx, 1);
      localStorage.setItem(tipo, JSON.stringify(arr));
      atualizarSelect(tipo);        // <— recarrega o select
      abrirModal(tipo);             // atualiza modal
    };

    // bind dos botões de modal
    document.getElementById("btn-cargo").onclick = () => abrirModal("cargo");
    document.getElementById("btn-filial").onclick = () => abrirModal("filial");

    // submissão do form
    document.getElementById("editarUsuarioForm").addEventListener("submit", function(e) {
      e.preventDefault();
      usuario.nome = document.getElementById("nome").value;
      usuario.email = document.getElementById("email").value;
      usuario.status = document.getElementById("status").value;
      usuario.administrador = document.getElementById("administrador").value;
      usuario.cargo = document.getElementById("cargo").value;
      usuario.filial = document.getElementById("filial").value;
      const novaSenha = document.getElementById("novaSenha").value.trim();
      if (novaSenha) usuario.senha = novaSenha;

      const idx = usuarios.findIndex(u => u.id === usuario.id);
      usuarios[idx] = usuario;
      localStorage.setItem("usuarios", JSON.stringify(usuarios));

      document.getElementById("notification").classList.remove("hidden");
      setTimeout(() => {
        window.location.href = "/docs/gerenciamentodeusuario.html";
      }, 1200);
    });
  });
  </script>
</body>
</html>
